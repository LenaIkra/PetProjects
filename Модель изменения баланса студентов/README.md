<div id="header" align="center">
  <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExYWhiOTgzemd4NG5qcm9lenFnYm8wNmt3YmRhbng2Mml1MmZwdjluNyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/kvazz2A4Pa2LHDMzwZ/giphy.gif" width="100"/>
  
</div>
<div id="badges" align="center">
  <img src="https://komarev.com/ghpvc/?username=LenaIkra&style=flat-square&color=blue" alt=""/>
</div> 

# Задача
Дана база данных онлайн-школы SkyEng студентов, учителей, уроков и пр. 
__Задача__ — смоделировать изменение балансов студентов. Баланс — это количество уроков, которое есть у каждого студента. 

1. Необходимо проверить данные в базе и ответить на вопросы:

   - Сколько всего уроков было на балансе **всех учеников** за каждый календарный день;

   - Как это количество менялось под влиянием транзакций (оплат, начислений, корректирующих списаний) и уроков (списаний с баланса по мере прохождения уроков);

   - Создать таблицу, где будут балансы **каждого студента** за каждый день. В результате должен получиться SQL-запрос, который собирает данные о балансах студентов за каждый "прожитый" ими день.

2. Выбрать топ-1000 строк из CTE `balances` с сортировкой по `user_id` и `dt`. Посмотреть на изменения балансов студентов. 

3. Создать визуализацию (линейную диаграмму) итогового результата. Сделать выводы.

___
# Описание базы данных
<details>
  <summary>
    SKYENG_DB (Metabase) </summary>
    
***classes***
    
***Витрина с уроками***
    
- **user_id** - уникальный идентификатор юзера
- **id_class** - уникальный идентификатор урока
- **class_start_datetime** - время начала урока
- **class_end_datetime** - время конца урока
- **class_removed_datetime** - время удаления записи о данном уроке
- **id_teacher** - уникальный идентификатор учителя
- **class_status** - статус урока (успешно проведен / отменен и тд)
- **class_status_datetime  -** время проставления статуса по уроку
    
**payments**
    
***Витрина с платежами по урокам***
    
- **user_id** - уникальный идентификатор юзера
- **id_transaction** - уникальный идентификатор транзакции
- **operation_name** - название проведенной операции
- **status_name** - статус проведенной операции (исполнена / не исполнена и тд)
- **classes** - количество оплаченных уроков
- **payment_amount** - выплаченная сумма
- **transaction_datetime** - время проведения операции
    
**students**
    
***Витрина со списком студентов***
    
- **user_id** - уникальный идентификатор юзера
- **student_sex** - пол юзера
- **geo_cluster** - географическая агрегация
- **country_name** - короткое название страны
- **region_name** - название региона
- **email_domain** - домен электронной почты
    
**teachers**
    
***Витрина со списком учителей***
    
- **id_teacher** - уникальный идентификатор учителя
- **age** - возраст
- **city** - город проживания учителя
- **department** - направление, в котором работает учитель
- **max_teaching_level** - название уровня языка у преподавателя
- **id_teaching_level** - уникальный идентификатор уровня языка у преподавателя
- **language_group** - основной язык преподавателя
</details>
____

# Решение
<details>
  <summary> 
Шаг 1. Поиск первой транзакции каждого студента </summary> 
Узнаем, когда была первая транзакция для каждого студента. Начиная с этой даты, мы будем собирать его баланс уроков. 
Создадим CTE `first_payments` с двумя полями: `user_id` и `first_payment_date` (дата первой успешной транзакции).
</details>
<details>
  <summary>
Шаг 2. Сбор всех уникальных дат уроков
  </summary>
Соберем таблицу с датами за каждый календарный день 2016 года. Выберем все даты из таблицы `classes`.
Создадим CTE `all_dates` с полем `dt`, где будут храниться уникальные даты (без времени) уроков.

</details>
<details>
  <summary>
Шаг 3. Создание таблицы дат жизни студента после его первой транзакции</summary>

Узнаем, за какие даты имеет смысл собирать баланс для каждого студента. Для этого объединим таблицы и создадим CTE all_dates_by_user, где будут храниться все даты жизни студента после того, как произошла его первая транзакция. 
В таблице должны быть такие поля: user_id, dt. 

</details>
<details>
  <summary> Шаг 4. Поиск изменения балансов успешных транзакций.
  </summary>
Найдем все изменения балансов, связанные с успешными транзакциями. Выберем все транзакции из таблицы payments, сгруппируем их по user_id и дате транзакции (без времени) и найдем сумму по полю classes. 
В результате получим CTE `payments_by_dates` с полями: `user_id`, `payment_date`, transaction_balance_change (сколько уроков было начислено или списано в этот день).

</details>
<details>
  <summary> Шаг 5. Поиск изменений балансов от транзакций.
  </summary>
  Найдем баланс студентов, который сформирован только транзакциями. Для этого объединим `all_dates_by_user` и `payments_by_dates` так, чтобы совпадали даты и `user_id`. Используем оконные выражения (функцию `sum`), чтобы найти кумулятивную сумму по полю `transaction_balance_change` для всех строк до текущей включительно с разбивкой по `user_id` и сортировкой по `dt`. 
**В результате** получим CTE `payments_by_dates_cumsum` с полями: `user_id`, `dt`, `transaction_balance_change` — `transaction_balance_change_cs` (кумулятивная сумма по `transaction_balance_change`). При подсчете кумулятивной суммы можно заменить пустые значения нулями.
</details>

<details>
  <summary> Шаг 6. Поиск изменений балансов от прохождения уроков.
  </summary>
Найдем изменения балансов из-за прохождения уроков. 
Создадим CTE `classes_by_dates`, посчитав в таблице `classes` количество уроков за каждый день для каждого ученика. 
Нас не интересуют вводные уроки и уроки со статусом, отличным от `success` и `failed_by_student`. 
**Получим результат** с такими полями: `user_id`, `class_date`, `classes` (количество пройденных в этот день уроков). Причем `classes` мы умножим на `-1`, чтобы отразить, что `-` — это списания с баланса.
</details>

<details>
  <summary> Шаг 7. Создание таблицы для хранения накопительной суммы количства пройденных уроков.
  </summary>
По аналогии с уже проделанным шагом для оплат создадим CTE для хранения кумулятивной суммы количества пройденных уроков. 
Для этого объединим таблицы `all_dates_by_user` и `classes_by_dates` так, чтобы совпадали даты и `user_id`. Используем оконные выражения (функцию `sum`), чтобы найти кумулятивную сумму по полю `classes` для всех строк до текущей включительно с разбивкой по `user_id` и сортировкой по `dt`. 
**В результате** получим CTE `classes_by_dates_dates_cumsum`с полями: `user_id`, `dt`, `classes` — `classes_cs`(кумулятивная сумма по `classes`). При подсчете кумулятивной суммы обязательно нужно заменить пустые значения нулями.
</details>

<details>
  <summary> Шаг 8. Создание таблицы баланса каждого студента
  </summary>
Создадим CTE `balances` ****с вычисленными балансами каждого студента. Для этого объединим таблицы `payments_by_dates_cumsum` ****и `classes_by_dates_dates_cumsum` так, чтобы совпадали даты и `user_id`.

**Получим такие поля:** `user_id`, `dt`, `transaction_balance_change`, `transaction_balance_change_cs`, `classes`, `classes_cs`, `balance` (`classes_cs` + `transaction_balance_change_cs`).
</details>

<details>
  <summary> Шаг 9. Поиск общего изменения количества уроков на балансах.
  </summary>
Посмотрим, как менялось общее количество уроков на балансах студентов.

Для этого просуммируем поля `transaction_balance_change`, `transaction_balance_change_cs`, `classes`, `classes_cs`, `balance` из CTE `balances` с группировкой и сортировкой по `dt`.
</details>

___
# Выводы

1. При просмотре таблицы `payments` возникает ряд вопросов для дата-инженеров и владельцев таблицы :
- Не везде проставлен id_transaction в таблице payments (для корпоративных клиентов), почему?
- Что значит отрицательный баланс в таблице payments?

2.По визуализации можно косвенно предположить рост числа студентов, так как растет количество транзакций и общий баланс уроков.

![alt text](image.png)